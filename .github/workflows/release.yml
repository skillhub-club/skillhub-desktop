name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'macOS-arm64'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'macOS-x64'
          - platform: 'windows-latest'
            args: ''
            name: 'Windows-x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install frontend dependencies
        run: npm ci

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS Signing & Notarization secrets
          # Uncomment these ONLY if you have configured the secrets in GitHub Settings
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'SkillHub Desktop ${{ github.ref_name }}'
          releaseBody: |
            See the [CHANGELOG](https://github.com/skillhub-club/skillhub-desktop/blob/main/CHANGELOG.md) for details.

            ## ⚠️ macOS Users / macOS 用户请注意
            If you encounter the "App is damaged" error or cannot open the app, it is because the app is not notarized by Apple yet. Please run the following command in your Terminal to fix it:
            
            如果打开应用时提示“应用已损坏”或无法打开，这是因为应用尚未经过 Apple 签名公证。请在终端（Terminal）中运行以下命令来解决：

            ```bash
            xattr -cr /Applications/"SkillHub Desktop.app"
            ```
            *(Make sure you have moved the app to the Applications folder / 确保您已经将应用拖入到了“应用程序”文件夹)*

            ## Downloads
            - **macOS (Apple Silicon)**: `.dmg` file for M1/M2/M3 Macs
            - **macOS (Intel)**: `.dmg` file for Intel Macs
            - **Windows**: `.msi` installer or `.exe` setup
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
